{% extends "ba_office/base_office.html" %}
{% load static %}
{% load office_tags %}
{% load humanize %}

{% block left_menu %}
{% include "ba_office/includes/lfstudent_left.html" %}
{% endblock %}

{% block extra_js %}
<script>
function fn_search() {
    document.schform.submit();
}
function sel_code_desc(val) {
    // 필드명 선택 → 지역코드 로드
    $.getJSON("{% url 'office_ajax_student_local' %}", {code_desc: val}, function(data) {
        var sel = document.schform.sch_local_code;
        sel.options.length = 1;
        for (var i = 0; i < data.length; i++) {
            sel.options[sel.options.length] = new Option(data[i].code_name, data[i].subcode);
        }
        // 구장/과정 초기화
        document.schform.sch_sta_code.options.length = 1;
        document.schform.sch_lecture_code.options.length = 1;
    });
}
function sel_stadium(local_code) {
    $.getJSON("{% url 'office_ajax_student_stadium' %}", {local_code: local_code}, function(data) {
        var sel = document.schform.sch_sta_code;
        sel.options.length = 1;
        for (var i = 0; i < data.length; i++) {
            sel.options[sel.options.length] = new Option(data[i].sta_name, data[i].sta_code);
        }
        document.schform.sch_lecture_code.options.length = 1;
    });
}
function sel_course(sta_code) {
    $.getJSON("{% url 'office_ajax_student_course' %}", {sta_code: sta_code}, function(data) {
        var sel = document.schform.sch_lecture_code;
        sel.options.length = 1;
        for (var i = 0; i < data.length; i++) {
            sel.options[sel.options.length] = new Option(data[i].lecture_title, data[i].lecture_code);
        }
    });
}
</script>
{% endblock %}

{% block content %}
<div class="navi">HOME  &gt;  수강생관리  &gt;  수강생정보</div>
<div class="h_55"></div>

<p class="title">수강생정보(NEW)</p>

<form name="schform" method="get" action="{% url 'office_student_list' %}">
<div class="tb_basic" style="margin-bottom:5px;">
<table summary="검색" border="0" cellpadding="0" cellspacing="0">
    <colgroup><col width="10%" /><col width="23%" /><col width="10%" /><col width="23%" /><col width="10%" /><col width="24%" /></colgroup>
    <tbody>
        <tr>
            <th scope="col">필드명</th>
            <td class="left">
                <select name="sch_code_desc" class="select" style="width:120px;" onchange="sel_code_desc(this.value);">
                    <option value="">==선택==</option>
                    {% for cd in code_descs %}
                    <option value="{{ cd }}" {% if sch_code_desc == cd %}selected{% endif %}>{{ cd }}</option>
                    {% endfor %}
                </select>
            </td>
            <th scope="col">구장명</th>
            <td class="left">
                <select name="sch_sta_code" class="select" style="width:120px;" onchange="sel_course(this.value);">
                    <option value="">==선택==</option>
                    {% for s in stadiums %}
                    <option value="{{ s.sta_code }}" {% if sch_sta_code == s.sta_code|stringformat:"d" %}selected{% endif %}>{{ s.sta_name }}</option>
                    {% endfor %}
                </select>
            </td>
            <th scope="col">과정명</th>
            <td class="left">
                <select name="sch_lecture_code" class="select" style="width:120px;">
                    <option value="">==선택==</option>
                    {% for c in courses %}
                    <option value="{{ c.lecture_code }}" {% if sch_lecture_code == c.lecture_code|stringformat:"d" %}selected{% endif %}>{{ c.lecture_title }}</option>
                    {% endfor %}
                </select>
            </td>
        </tr>
        <tr>
            <th scope="col">수강상태</th>
            <td class="left">
                <select name="sch_lecture_stats" class="select" style="width:120px;">
                    <option value="">==전체==</option>
                    <option value="LY" {% if sch_lecture_stats == "LY" %}selected{% endif %}>수강확정</option>
                    <option value="LP" {% if sch_lecture_stats == "LP" %}selected{% endif %}>수강예정</option>
                    <option value="LN" {% if sch_lecture_stats == "LN" %}selected{% endif %}>퇴단</option>
                    <option value="PN" {% if sch_lecture_stats == "PN" %}selected{% endif %}>일시중지</option>
                </select>
            </td>
            <th scope="col">결제상태</th>
            <td class="left">
                <select name="sch_pay_stats" class="select" style="width:120px;">
                    <option value="">==전체==</option>
                    <option value="PP" {% if sch_pay_stats == "PP" %}selected{% endif %}>결제대기</option>
                    <option value="PQ" {% if sch_pay_stats == "PQ" %}selected{% endif %}>입금확인대기</option>
                    <option value="PY" {% if sch_pay_stats == "PY" %}selected{% endif %}>결제완료</option>
                </select>
            </td>
            <th scope="col">기준월</th>
            <td class="left">
                <select name="sch_ym" class="select" style="width:120px;">
                    {% for ym in ym_choices %}
                    <option value="{{ ym }}" {% if sch_ym == ym %}selected{% endif %}>{{ ym|slice:":4" }}-{{ ym|slice:"4:6" }}</option>
                    {% endfor %}
                </select>
            </td>
        </tr>
        <tr>
            <th scope="col">수강생명</th>
            <td class="left" colspan="3">
                <input type="text" name="sch_child_name" value="{{ sch_child_name }}" class="input" style="width:150px;" />
            </td>
            <td colspan="2" class="left">
                <a href="javascript:fn_search();"><img src="{% static 'ba_office/images/btn_search.gif' %}" alt="검색" /></a>
            </td>
        </tr>
        <input type="hidden" name="sch_local_code" value="{{ sch_local_code }}" />
    </tbody>
</table>
</div>
</form>

<p style="margin:5px 0;">총 <b>{{ total_count }}</b>건</p>

<div class="scroll">
<table class="tb_scroll" border="0" cellpadding="0" cellspacing="0">
    <colgroup>
        <col width="4%" /><col width="8%" /><col width="8%" /><col width="8%" />
        <col width="8%" /><col width="8%" /><col width="8%" /><col width="8%" />
        <col width="8%" /><col width="8%" /><col width="8%" /><col width="6%" />
    </colgroup>
    <thead>
    <tr>
        <th>No</th>
        <th>회원ID</th>
        <th>자녀ID</th>
        <th>자녀명</th>
        <th>구장명</th>
        <th>수강상태</th>
        <th>결제상태</th>
        <th>신청구분</th>
        <th>시작월</th>
        <th>종료월</th>
        <th>결제방법</th>
        <th>상세</th>
    </tr>
    </thead>
    <tbody>
    {% for e in students %}
    <tr>
        <td>{{ forloop.counter|page_index:students.start_index }}</td>
        <td>{{ e.member_id }}</td>
        <td>{{ e.child_id }}</td>
        <td>{{ e.child.name }}</td>
        <td>{% with lec=enrollment_lecture_map|default_if_none:"" %}{% if lec %}{% with l=enrollment_lecture_map %}{% for eid, lecture in l.items %}{% if eid == e.id %}{{ lecture.stadium.sta_nickname }}{% endif %}{% endfor %}{% endwith %}{% endif %}{% endwith %}</td>
        <td>{{ e.get_lecture_stats_display }}</td>
        <td>{{ e.get_pay_stats_display }}</td>
        <td>{{ e.get_apply_gubun_display }}</td>
        <td>{{ e.start_dt|slice:":4" }}-{{ e.start_dt|slice:"4:6" }}</td>
        <td>{{ e.end_dt|slice:":4" }}-{{ e.end_dt|slice:"4:6" }}</td>
        <td>{{ e.get_pay_method_display }}</td>
        <td><a href="{% url 'office_student_detail' e.id %}"><img src="{% static 'ba_office/images/btn_detail.gif' %}" alt="상세" /></a></td>
    </tr>
    {% empty %}
    <tr><td colspan="12">검색 결과가 없습니다.</td></tr>
    {% endfor %}
    </tbody>
</table>
</div>

{% if students.has_other_pages %}
<div style="text-align:center; margin:10px 0;">
    {% for p in students.paginator.page_range %}
        {% if p == students.number %}
        <b>[{{ p }}]</b>
        {% else %}
        <a href="?page={{ p }}&sch_ym={{ sch_ym }}&sch_code_desc={{ sch_code_desc }}&sch_local_code={{ sch_local_code }}&sch_sta_code={{ sch_sta_code }}&sch_lecture_code={{ sch_lecture_code }}&sch_lecture_stats={{ sch_lecture_stats }}&sch_pay_stats={{ sch_pay_stats }}&sch_child_name={{ sch_child_name }}">[{{ p }}]</a>
        {% endif %}
    {% endfor %}
</div>
{% endif %}

<!-- 대기등록자 -->
{% if wait_students %}
<div class="h_55"></div>
<p class="title">대기등록자</p>
<div class="scroll">
<table class="tb_scroll" border="0" cellpadding="0" cellspacing="0">
    <colgroup><col width="5%" /><col width="15%" /><col width="15%" /><col width="15%" /><col width="15%" /><col width="15%" /><col width="20%" /></colgroup>
    <thead>
    <tr>
        <th>No</th>
        <th>구장명</th>
        <th>회원ID</th>
        <th>회원명</th>
        <th>자녀ID</th>
        <th>자녀명</th>
        <th>신청일</th>
    </tr>
    </thead>
    <tbody>
    {% for w in wait_students %}
    <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ w.sta_code }}</td>
        <td>{{ w.member_id }}</td>
        <td>{{ w.member_name }}</td>
        <td>{{ w.child_id }}</td>
        <td>{{ w.child_name }}</td>
        <td>{{ w.insert_dt|date:"Y-m-d" }}</td>
    </tr>
    {% endfor %}
    </tbody>
</table>
</div>
{% endif %}

{% endblock %}
