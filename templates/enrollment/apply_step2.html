{% extends "base.html" %}
{% load static %}

{% block title %}입단신청 - 프로모션 확인 - AAFC{% endblock %}

{% block content %}
    <div id="sub_contents">
        <div class="sub_top member"><img src="{% static 'images/sub/sub_top_m_member.jpg' %}" alt=""/></div>
        <div class="sub_menu">
            <ul>
                <li class="present"><a href="{% url 'enrollment:apply_step1' %}">입단신청</a></li>
            </ul>
        </div>
        <div class="sub_contents">
            <h2 class="sub_tit">입단신청 - 프로모션 확인<span><img src="{% static 'images/sub/home_ico.jpg' %}" alt=""/>HOME&nbsp;&nbsp;>&nbsp;&nbsp;<b>입단신청</b>&nbsp;&nbsp;>&nbsp;&nbsp;프로모션 확인</span></h2>

            <form id="frmStep2" method="post" action="{% url 'enrollment:apply_step3' %}">
                {% csrf_token %}
                <input type="hidden" name="EQ_Discount" id="EQ_Discount" value="0"/>
                <input type="hidden" name="EQ_Discount_id" id="EQ_Discount_id" value=""/>
                <input type="hidden" name="Tu_Discount" id="Tu_Discount" value="0"/>
                <input type="hidden" name="Tu_Discount_id" id="Tu_Discount_id" value=""/>
                <input type="hidden" name="PY_Discount" id="PY_Discount" value="0"/>
                <input type="hidden" name="PY_Discount_id" id="PY_Discount_id" value=""/>
                <input type="hidden" name="PY3_Discount" id="PY3_Discount" value="0"/>
                <input type="hidden" name="RD_Discount" id="RD_Discount" value="0"/>
                <input type="hidden" name="O2_Discount" id="O2_Discount" value="0"/>
                <input type="hidden" name="O2_Discount_id" id="O2_Discount_id" value=""/>

                <!-- 선택 내역 확인 -->
                <h3 class="member_tit">선택 내역 확인</h3>
                <table class="join_info" summary="">
                    <colgroup><col width="20%"/><col width="80%"/></colgroup>
                    <tbody>
                        <tr>
                            <th>자녀</th>
                            <td>{{ child.name }}</td>
                        </tr>
                        <tr>
                            <th>권역 / 구장</th>
                            <td>{{ local_name }} / {{ sta_name }}</td>
                        </tr>
                        <tr>
                            <th>수강횟수 / 기간</th>
                            <td>주 {{ lec_cycle }}회 / {{ lec_period }}개월</td>
                        </tr>
                        <tr>
                            <th>시작월</th>
                            <td>{{ sym|slice:":4" }}년 {{ sym|slice:"4:6" }}월</td>
                        </tr>
                        {% for lec in lecture_details %}
                        <tr>
                            <th>강좌 {{ forloop.counter }}</th>
                            <td>{{ lec.title }} ({{ lec.day_display }} {{ lec.time }}) - {{ lec.start_day }}일 시작 / {{ lec.count }}회 / {{ lec.total_price|floatformat:0 }}원</td>
                        </tr>
                        {% endfor %}
                        {% if recommend_id %}
                        <tr>
                            <th>추천인</th>
                            <td>{{ recommend_id }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>교육용품비</th>
                            <td>{% if end_chk > 0 %}면제 (재입단){% else %}{{ join_price|floatformat:0 }}원{% endif %}</td>
                        </tr>
                        <tr>
                            <th>수강료 합계</th>
                            <td><b>{{ total_lecture_price|floatformat:0 }}원</b></td>
                        </tr>
                    </tbody>
                </table>

                <!-- 프로모션/할인 -->
                <h3 class="member_tit">프로모션 / 할인</h3>
                <div id="area_promotion">
                    <p>할인내역을 불러오는 중...</p>
                </div>

                <!-- 버튼 -->
                <div class="join_btn">
                    <button type="button" onclick="goStep3()" class="btn_join">결제하기</button>
                    <button type="button" onclick="history.back()" class="btn_cancel">이전단계</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
$(document).ready(function() {
    // 프로모션 로드
    var codes = [];
    {% for lec in lecture_details %}
    codes.push("{{ lec.code }}");
    {% endfor %}

    $.ajax({
        url: "{% url 'enrollment:ajax_promotions' %}",
        data: {
            child_id: "{{ child.child_id }}",
            end_chk: "{{ end_chk }}",
            lec_cycle: "{{ lec_cycle }}",
            lec_period: "{{ lec_period }}",
            lecture_codes: codes.join(",")
        },
        success: function(data) {
            $("#area_promotion").html(data);
        }
    });
});

function applyDiscount(type, amount, discountId) {
    if (type == 'eq') {
        $("#EQ_Discount").val(amount);
        $("#EQ_Discount_id").val(discountId);
    } else if (type == 'tu') {
        $("#Tu_Discount").val(amount);
        $("#Tu_Discount_id").val(discountId);
    } else if (type == 'py') {
        $("#PY_Discount").val(amount);
        $("#PY_Discount_id").val(discountId);
    } else if (type == 'o2') {
        $("#O2_Discount").val(amount);
        $("#O2_Discount_id").val(discountId);
    }
}

function goStep3() {
    $("#frmStep2").submit();
}
</script>
{% endblock %}
